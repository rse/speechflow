##
##  speechflow.yaml -- Speechflow Sample Audio Processing Graphs
##

#   Capture and meter audio from microphone device into WAV audio file
capturing: |
    xio-device(device: env.SPEECHFLOW_DEVICE_MIC, mode: "r") |
        a2a-vad() |
            a2a-meter(1000) |
                a2a-wav(mode: "encode", seekable: true) |
                    xio-file(path: "capture.wav", mode: "w", type: "audio", seekable: true)

#   Pass-through audio from microphone device to speaker
#   device and in parallel record it to WAV audio file
pass-through: |
    xio-device(device: env.SPEECHFLOW_DEVICE_MIC, mode: "r") | {
        a2a-wav(mode: "encode") |
            xio-file(path: "capture.wav", mode: "w", type: "audio"),
        xio-device(device: env.SPEECHFLOW_DEVICE_SPK, mode: "w")
    }

#   Generate text file with German transcription of German MP3 audio file
transcription: |
    xio-file(path: argv.0, mode: "r", type: "audio") |
        a2a-ffmpeg(src: "mp3", dst: "pcm") |
            a2t-deepgram(language: "de") |
                t2t-format(width: 80) |
                    xio-file(path: argv.1, mode: "w", type: "text")

#   Generate WebVTT file with German closed captions of German WAV audio file
captioning: |
    xio-file(path: argv.0, mode: "r", type: "audio") |
        a2a-wav(mode: "decode") |
            a2t-deepgram(language: "de") |
                t2t-subtitle(format: "vtt") |
                    xio-file(path: argv.1, mode: "w", type: "text")

#   Generate WebVTT file with English subtitles of German WAV audio file
subtitling: |
    xio-file(path: argv.0, mode: "r", type: "audio") |
        a2a-wav(mode: "decode") |
            a2t-deepgram(language: "de") |
                t2t-deepl(src: "de", dst: "en") |
                    t2t-subtitle(format: "vtt") |
                        xio-file(path: argv.1, mode: "w", type: "text")

#   Generate German WAV audio file from WebVTT file containing German subtitles
synthesis: |
    xio-file(path: argv.0, mode: "r", type: "text") |
        t2t-subtitle(format: "vtt", mode: "import") |
            t2a-elevenlabs(voice: "Mark", optimize: "quality", speed: 1.05, language: "en") |
                a2a-filler() |
                    a2a-wav(mode: "encode") |
                        xio-file(path: argv.1, mode: "w", type: "audio")

#   Ad-Hoc text translation from German to English
translation: |
    xio-file(path: "-", mode: "r", type: "text") |
        t2t-deepl(src: "de", dst: "en") |
            xio-file(path: "-", mode: "w", type: "text")

#   Generate audio file with English voice for a text file
speaking: |
    xio-file(path: argv.0, mode: "r", type: "text") |
        t2a-kokoro(language: "en") |
            a2a-wav(mode: "encode") |
                xio-file(path: argv.1, mode: "w", type: "audio")

#   Batch studio transcription from German to English,
#   including the capturing of all involved inputs and outputs:
studio-transcription: |
    xio-file(path: argv.0, mode: "r", type: "audio") | {
        a2a-ffmpeg(src: "mp3", dst: "pcm") | {
            a2t-deepgram(language: "de") | {
                t2t-format(width: 80) |
                    xio-file(path: argv.1, mode: "w", type: "text"),
                t2t-subtitle(format: "vtt") |
                    xio-file(path: argv.2, mode: "w", type: "text"),
                t2t-subtitle(format: "srt") |
                    xio-file(path: argv.3, mode: "w", type: "text"),
                t2a-elevenlabs(voice: "Mark", optimize: "quality", speed: 1.05, language: "en") |
                    a2a-wav(mode: "encode") |
                        xio-file(path: argv.4, mode: "w", type: "audio")
            }
        }
    }

#   Real-time studio translation from German to English,
#   including the capturing of all involved inputs and outputs:
studio-translation: |
    xio-device(device: env.SPEECHFLOW_DEVICE_MIC, mode: "r", chunk: 200) | {
        a2a-meter(interval: 50, dashboard: "audio-de", mode: "sink"),
        a2t-deepgram(language: "de", model: "nova-2", interim: true) | {
            x2x-trace(type: "text", dashboard: "text-de-interim", mode: "sink"),
            t2t-subtitle(mode: "render", addr: env.SPEECHFLOW_IPADDR, port: 8585),
            t2t-sentence() | {
                x2x-filter(name: "final", type: "text", var: "kind", op: "==", val: "final") | {
                    t2t-format(width: 80) |
                        xio-file(path: `${env.SPEECHFLOW_DATADIR}/program-de.txt`, mode: "w", type: "text"),
                    t2t-subtitle(mode: "export", format: "srt") |
                        xio-file(path: `${env.SPEECHFLOW_DATADIR}/program-de.srt`, mode: "w", type: "text"),
                    x2x-trace(type: "text", dashboard: "text-de-final", mode: "sink") /* DE-Final */
                },
                t2t-deepl(src: "de", dst: "en") | {
                    x2x-trace(type: "text", dashboard: "text-en-interim", mode: "sink"),
                    t2t-subtitle(mode: "render", addr: env.SPEECHFLOW_IPADDR, port: 8686),
                    x2x-filter(name: "final", type: "text", var: "kind", op: "==", val: "final") | {
                        t2t-format(width: 80) |
                            xio-file(path: `${env.SPEECHFLOW_DATADIR}/program-en.txt`, mode: "w", type: "text"),
                        t2t-subtitle(mode: "export", format: "srt") |
                            xio-file(path: `${env.SPEECHFLOW_DATADIR}/program-en.srt`, mode: "w", type: "text"),
                        x2x-trace(type: "text", dashboard: "text-en-final", mode: "sink"),
                        t2a-elevenlabs(voice: "Mark", optimize: "latency", speed: 1.05, language: "en") | {
                            a2a-meter(interval: 50, dashboard: "audio-en", mode: "sink"),
                            xio-device(device: env.SPEECHFLOW_DEVICE_SPK, mode: "w")
                        }
                    }
                }
            }
        }
    }
